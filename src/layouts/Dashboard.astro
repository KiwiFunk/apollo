---
import SiteLayout from "../layouts/SiteLayout.astro";
import NoteStoreInitializer from "../components/NoteStoreInitializer.tsx";
import type { NoteMeta } from "../types";

// Import Components
import Sidebar from "../components/Sidebar.tsx";
import Navbar from "../components/Navbar.astro";

// Get the authenticated user from Astro.locals/Our Middleware
const { user } = Astro.locals;

// If there is no session/user, redirect to /auth
if (!user) return Astro.redirect("/auth");

// Function to fetch notes for the authenticated user
const getNotes = async () => {
    // Pass cookies for authentication (e.g., session token)
    const cookies = Astro.request.headers.get('cookie');

    const response = await fetch(`${Astro.url.origin}/api/notes`, {
        headers: {
            'cookie': cookies || ''
        }
    });
    if (!response.ok) {
        throw new Error("Failed to fetch notes");
    }
    return response.json();
};

// Fetch user notes
const userNotes: NoteMeta[] = await getNotes();
---

<SiteLayout title="Apollo - Home">

    <!-- Initialize the notes store with user notes -->
    <NoteStoreInitializer initialData={userNotes} client:only="preact" />

    <div class="flex flex-col h-screen">
        <!-- Navbar -->
        <Navbar transition:persist />

        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Categories Sidebar -->
            <Sidebar client:load transition:persist />

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto">
                <slot />
            </main>
        </div>
    </div>
</SiteLayout>

---
import SiteLayout from "../layouts/SiteLayout.astro";
import NoteStoreInitializer from "../components/NoteStoreInitializer.tsx";
import type { NoteMeta } from "../types";

// Import Components
import Sidebar from "../components/Sidebar.tsx";
import Navbar from "../components/Navbar.astro";

// DB Imports
import { db } from "../db";
import { note_metadata } from "../db/schema";
import { eq, desc } from "drizzle-orm";

// Get user from locals (Middleware already handled auth!)
const { user } = Astro.locals;

// Redirect if no user (Safety check)
if (!user) {
    return Astro.redirect('/auth');
}

// Direct DB Query (SSR Build)
let userNotes: NoteMeta[] = [];

try {
    userNotes = await db.select()
        .from(note_metadata)
        .where(eq(note_metadata.userId, user.id))
        .orderBy(desc(note_metadata.publishDate));
} catch (error) {
    console.error("Failed to fetch notes from DB:", error);
    // userNotes remains [] if error occurs, preventing crash
}
---

<SiteLayout title="Apollo - Home">

    <!-- Initialize the notes store with user notes -->
    <NoteStoreInitializer initialData={userNotes} client:only="preact" />

    <div class="flex flex-col h-screen">
        <!-- Navbar -->
        <Navbar client:load transition:persist />

        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Categories Sidebar -->
            <Sidebar client:load transition:persist />

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto">
                <slot />
            </main>
        </div>
    </div>
</SiteLayout>

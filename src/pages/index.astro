---
import SiteLayout from "../layouts/SiteLayout.astro";
import type { Note } from "../types";

// Import Components
import Search from "../components/Search.tsx";
import DynamicContent from "../components/DynamicContent.tsx";
import BurgerButton from "../components/BurgerButton.tsx";
import Sidebar from "../components/Sidebar.tsx";
import LogoutButton from "../components/LogoutButton.tsx";

import { db } from "../db"; // Import the Drizzle client
import { notes as notesTable } from "../db/schema"; // Import the notes table schema
import { desc, eq } from "drizzle-orm"; // Import descending for sorting, and eq (equals) operator

// Get the authenticated user from Astro.locals/Our Middleware
const { user } = Astro.locals;

// If there is no session/user, redirect to /auth
if (!user) return Astro.redirect("/auth");

// Use Drizzle query builder to fetch notes. WHERE userId matches the current User's ID
// Type-safe and returns a `Note[]` array.
const allNotes: Note[] = await db
    .select()
    .from(notesTable)
    .where(eq(notesTable.userId, user.id))
    .orderBy(desc(notesTable.publishDate));

// Normalize notes for search functionality
const searchList = allNotes.map((note) => ({
    title: note.title,
    description: note.description || "",
    category: note.category || "Uncategorized",
    slug: note.slug,
    content: note.content || "",
}));

// Create an object to hold notes categorized by their category
const notesByCategory = allNotes.reduce(
    (categoryMap: Record<string, Note[]>, note: Note) => {
        // Determine the category of the note, default to "Uncategorized" if not present
        const category = note.category || "Uncategorized";

        // Initialize the category array if it doesn't exist yet
        if (!categoryMap[category]) {
            categoryMap[category] = [];
        }

        // Add the current note to the appropriate category
        categoryMap[category].push(note);

        return categoryMap;
    },
    {},
); // Initial value is an empty object
---

<SiteLayout title="Apollo - Home">
    <div class="flex flex-col h-screen">
        <!-- Navbar -->
        <nav
            class="bg-white border-b border-gray-200 w-full shrink-0 shadow-sm"
        >
            <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="relative flex items-center justify-between h-16">
                    <!-- Conditional Branding/Burger Menu -->
                    <div class="flex items-center">
                        <!-- Burger Menu Icon For Mobile -->
                        <BurgerButton client:load />

                        <!-- Branding for Desktop -->
                        <div class="hidden lg:block absolute">
                            <span class="text-2xl font-bold text-gray-900"
                                >apollo</span
                            >
                        </div>
                    </div>

                    <!-- Centered Search Bar -->
                    <div class="flex-1 flex justify-center px-2">
                        <div class="max-w-md w-full lg:max-w-xl">
                            <label for="search" class="sr-only">Search</label>
                            <div class="relative">
                                <Search client:load searchList={searchList} />
                            </div>
                        </div>
                    </div>

                    <!-- Logout Button using Better-Auth endpoint -->
                    <div class="">
                        <LogoutButton client:load />
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Categories Sidebar -->
            <Sidebar client:load notesByCategory={notesByCategory} />

            <!-- Homepage / Note Display Window -->
            <main class="flex-1 overflow-y-auto">
                <DynamicContent
                    client:idle
                    allNotes={allNotes}
                    notesByCategory={notesByCategory}
                />
                <slot />
            </main>
        </div>
    </div>
</SiteLayout>

---
import SiteLayout from "../layouts/SiteLayout.astro";
import type { Note } from "../types";

// Import Components
import DynamicContent from "../components/DynamicContent.tsx";
import Sidebar from "../components/Sidebar.tsx";
import Navbar from "../components/Navbar.astro";


import { db } from "../db"; // Import the Drizzle client
import { notes as notesTable } from "../db/schema"; // Import the notes table schema
import { desc, eq } from "drizzle-orm"; // Import descending for sorting, and eq (equals) operator

// Get the authenticated user from Astro.locals/Our Middleware
const { user } = Astro.locals;

// If there is no session/user, redirect to /auth
if (!user) return Astro.redirect("/auth");

// Use Drizzle query builder to fetch notes. WHERE userId matches the current User's ID
// Type-safe and returns a `Note[]` array.
const userNotes: Note[] = await db
    .select()
    .from(notesTable)
    .where(eq(notesTable.userId, user.id))
    .orderBy(desc(notesTable.publishDate));

// Create an object to hold notes categorized by their category
const notesByCategory = userNotes.reduce(
    (categoryMap: Record<string, Note[]>, note: Note) => {
        // Determine the category of the note, default to "Uncategorized" if not present
        const category = note.category || "Uncategorized";

        // Initialize the category array if it doesn't exist yet
        if (!categoryMap[category]) {
            categoryMap[category] = [];
        }

        // Add the current note to the appropriate category
        categoryMap[category].push(note);

        return categoryMap;
    },
    {},
); // Initial value is an empty object
---

<SiteLayout title="Apollo - Home">
    <div class="flex flex-col h-screen">
        <!-- Navbar -->
        <Navbar client:load notes={userNotes} />

        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Categories Sidebar -->
            <Sidebar client:load notesByCategory={notesByCategory} />

            <!-- Homepage / Note Display Window -->
            <main class="flex-1 overflow-y-auto">
                <DynamicContent
                    client:idle
                    userNotes={userNotes}
                    notesByCategory={notesByCategory}
                />
                <slot />
            </main>
        </div>
    </div>
</SiteLayout>

---
import Dashboard from "../../layouts/Dashboard.astro";
import type { FullNote } from "../../types";
import NoteViewer from "../../components/NoteViewer.tsx";

// Get the slug from the URL params
const { slug } = Astro.params;

// Security: If no slug, go back immediately
if (!slug) return Astro.redirect("/");

// Fetch full note data for the given slug (metadata + content)
// Returns a FullNote object (metadata + content)
const getNote = async (noteSlug: string): Promise<FullNote> => {

    // Fetch the requested note from the Database
    const response = await fetch(new URL(`/api/notes/${slug}`, Astro.url), {
        headers: {
            cookie: Astro.request.headers.get("cookie") || ""
        }
    });

    if (response.status === 404) {
        // Handle 404 specifically for a note not found
        // TODO: Create a generic 404 Page
        throw new Error(`Note not found: ${noteSlug}`); 
    }
    // Else handle other errors
    if (!response.ok) {
        throw new Error(`Failed to fetch note ${noteSlug}. Status: ${response.status}`);
    }

    return response.json();
};

// Fetch the full note data
let noteData: FullNote | null = null;
if (slug) {
    try {
        noteData = await getNote(slug);
    } catch (error) {
        console.error("Fatal error fetching note:", error);
        return new Response('Note could not be loaded.', { status: 500 });
    }
}
// If slug is missing, redirect or handle
if (!slug || !noteData) {
    return Astro.redirect("/dashboard");
}

---

<Dashboard>
    <NoteViewer note={noteData} client:load />
</Dashboard>
---
import MainApp from '../../components/MainApp.astro';
import { db } from '../../db';
import { notes } from '../../db/schema';
import { eq } from 'drizzle-orm';

/*
    [slug] lets us create dynamic routes based on note slugs
    if we only used index, refreshing the page on a note would 404
*/

export async function getStaticPaths() {
    // Get the current user from Astro.locals (provided by middleware)
    const { user } = Astro.locals;
    
    // If there's no authenticated user, return an empty array (no valid paths)
    if (!user) {
        return [];
    }
    
    // Fetch only the notes belonging to this specific user
    const userNotes = await db
        .select()
        .from(notes)
        .where(eq(notes.userId, user.id));
    
    // Return an array of valid paths for this user's notes
    return userNotes.map((note) => ({
        params: { slug: note.slug },
    }));
}
---
<MainApp />
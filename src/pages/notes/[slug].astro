---
import Dashboard from "../../layouts/Dashboard.astro";
import NoteViewer from "../../components/NoteViewer.tsx";
import type { FullNote } from "../../types";

// DB Access Imports
import { db } from "../../db";
import { eq, and } from "drizzle-orm";
import { note_metadata } from "../../db/schema";

// Get the slug from the URL params & Current User
const { slug } = Astro.params;
const { user } = Astro.locals;

// Security Checks
if (!slug) return Astro.redirect("/");
if (!user) return Astro.redirect("/auth");

// Use the Drizzle relationship helper to join metadata and content 
const noteResult = await db.query.note_metadata.findFirst({
    where: and(
        eq(note_metadata.slug, slug),       // Match the slug
        eq(note_metadata.userId, user.id)   // Ensures the note belongs to the user
    ),
    // Use relational helper to JOIN note_content table
    with: {
        content: true
    }
});

if (!noteResult) {
    console.error(`Note not found: ${slug}`);
    return Astro.redirect("/dashboard");
}

// Construct the FullNote object expected by NoteViewer
const fullNote: FullNote = {
    metadata: {
        id: noteResult.id,
        userId: noteResult.userId,
        slug: noteResult.slug,
        title: noteResult.title,
        description: noteResult.description,
        publishDate: noteResult.publishDate,
        category: noteResult.category,
    },
    content: noteResult.content?.content || ''
};

---

<Dashboard>
    <NoteViewer note={fullNote} client:load />
</Dashboard>